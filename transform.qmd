---
title: "Transform"
author: "Trevor S"
---

## Setup

We install and load the necessary packages, along with functions from prior chapters.

```{r,  message = FALSE, warning = FALSE}
# install.packages("tidyverse")
# install.packages("dplyr")
# install.packages("gt")
# install.packages("reactable")

library(tidyverse)
library(dplyr)
library(gt)
library(reactable)

source("functions.R") # load functions defined in prior chapters
```

## Introduction

In the transform step, we will transform our data to better include the careers of players who are still playing. In the previous chapter, we estimated the value of pick $n$ by taking the average PS of all players in out dataset drafted at pick $n$. As mentioned in the constraints section, one problem with this approach is that players drafted more recently will have had fewer years to generate PS. We can see in the plot below that, unsurprisingly, the total PS is quite a bit lower for the drafts between 2016 and 2020:

```{r}
all_data |> 
  group_by(year) |> 
  summarize(total_ps = sum(ps)) |>
  ggplot(aes(x = year, y = total_ps)) +
  geom_point()
```

A similar issue is that there are quite a few current players who can still generate additional PS in our dataset. This issue is related because it is probably reasonable to expect that the discrepency between the 2016-2020 PS totals and the other years is due to there being so many active players from those seasons.

```{r}
all_data |> 
  filter(to == 2025) |> 
  group_by(year) |> 
  summarize(current_players = n()) |>
  ggplot(aes(x = year, y = current_players)) + 
  geom_point()
```

We can see that there are still quite a few players who are currently playing, so the full value of their career cannot be fully known. It is interesting that PS is so high for the drafts between 2007 and 2015 even though there are still so many active players from those drafts, I did some research but I could not find anything about it. One of my theories is that elite players might be skewing things, but Connor McDavid was drafted in 2015 but even he "only" has about 125 PS which is not nearly enough to skew the data on its own. I guess it is possible there were just really strong drafts, but it seems odd that there would be 8 strong drafts in a row.

Estimating the remaining value of a player's career could be an entire project all on its own, so we have 3 options:

-   Only include drafts from before 2003 (there are no active NHL players who were drafted in 2002 or earlier).

-   Ignore this issue altogether (as if every active player in our dataset retired right now).

-   Make some sort of adjustment to the PS values of active players to account for the remainder of their career.

Neither of the first two options are particularly appealing. The first is unideal because of sample size concerns and the changes that have taken place in terms of draft eligibility and strategy since the 1980s (which we would need to include to maintain a sample size of 25). Additionally, the second option is arguably worse because it will severely underestimate the quality of star players drafted in the last few years (elite players can play for 15-20 seasons, so we could be missing three quarters of a player's career if he was drafted in 2020). Thus the only remaining option is to attempt to estimate the remaining value of a players career.

Estimating the remaining value of a player's career could be an entire project all on its own, but we will make an adjustment that will reduce the impact of this issue (while acknowledging that we will not completely fix it). Let $gp_{ps}$ and $ps_{ij}$ be the GP and PS of the player drafted at pick $i$ of draft $j$. If that player has not retired, we will set $ps^{adj}_{ij} = ps_{ij} + \frac{ps_{ij}}{gp_{ij}} \times \hat{gr_j}$, where $\hat {gr_j}$ is our [**estimate**]{.underline} of the number of games left in the career of players drafted in year $j$. We will set $\hat{gr_j} = \frac{gp_{ij}}{years_{ij}} \cdot \hat{yr_j}$, where $years_{ij}$ is the number of years since player $ij$ was drafted and $\hat{yr_j}$ is the estimated number of years left in their career. Thus the estimated number of games remaining in a player's career is their average number of games per season times the estimated number of years remaining. Simplifying, we have $ps_{ij}^{adj} = ps_{ij} + \frac{ps_{ij}}{years_{ij}} \cdot\hat{yr_{ij}}$. We will estimate $yr_j$ later using data from 1996-2004. When we actually code this adjustment later in this chapter we will verify that the PS values these drafts end up looking similar to drafts where everyone is retired. Note that we only make this adjustment for active players, there is no reason to adjust the PS of retired players.

## Code

Let $yr_j$ be the nunber of years players drafted in draft $j$ have remaining in their career, given they were drafted $k$ years ago. We aim to estimate this value, and will do so by setting $\hat{yr_j}$ to be the mean career length of players who retired at $k$ years after being drafted and were drafted between 1996 and 2004. We calculate it for $1 \le k \le 22$ to make the indexing more intuitive, even though we will only be using the values $k \ge 5$, since no active player drafted in 2020 or earlier can have played for less than 4 seasons..

```{r}
get_length <- function(len){ 
  all_data |> 
    mutate(rem_career_len = to - year - len) |> 
    filter(year %in% 1996:2004 & rem_career_len >= 0) |> 
    summarize(mean = mean(rem_career_len)) |> 
    pull(mean)
}

est_yr <- data.frame(k = seq(1,22)) |> 
  rowwise() |> 
  mutate(yr = get_length(k)) |> 
  ungroup()

ggplot(est_yr, aes(x = k, y = yr)) + 
  geom_line() 
```

The interpretation for this is a player who was drafted 1 year ago has an estimated 9 years left in their career, a player who was drafted 5 years ago has an estimated 6 years left in their career, and a player who was drafted 10 years ago has an estimated 4 years remaining in their career. We can now make our adjustments:

```{r}
all_data_adj <- all_data |> 
  filter(to == 2025) |> 
  mutate(career_len = to - year) |> 
  rowwise() |> 
  mutate(adj_ps = ps + round(ps / career_len * get_length(career_len), 2)) |> 
  ungroup() |> 
  select(year:ps, adj_ps)

inactive_players <- all_data |> 
  filter(to != 2025) |> 
  mutate(adj_ps = ps)


all_data_adj <- rbind(all_data_adj, inactive_players)
reactable(all_data_adj)
```

Note that the adjusted PS values for players who are expected to retire soon may not have changed at all. To say it again, this estimation is not perfect, but it is better than the alternatives (using older data or ignoring the issue). In particular, this method assumes all players will continue to generate PS at the same rate as they have to this point in their career, and that the number of additional years a player will play for only depends on how many years ago they were drafted.

We can do some checks to see if these estimates seem feasible. First, we recreate the plot of total PS by year from the start of this chapter. We plot all the years for sake of comparison, but recall we only made changes for active players, and thus the drafts between 1996 and 2002 were completely unaffected:

```{r}
all_data_adj |> 
  group_by(year) |> 
  summarize(total_ps = sum(ps), total_adj_ps = sum(adj_ps)) |>
  pivot_longer(cols = starts_with("total"), 
               names_to = "metric", values_to = "value") |> 
  ggplot(aes(x = year, y = value, col = metric)) +
  geom_point()
```

The 5 drafts after 2015 are considerably closer to the other draft than they were before, so at first glance it seems like the adjustment we have made was good. We can also check if the adjusted drafts seem similar to the drafts which required little adjustment, we do this by comparing a histogram of the drafts between 1996 and 200 with the drafts between 2016 and 2020. Of course, we're not expecting them to be perfectly identical because there is a fair amount of variation even between drafts that required little to no adjustment (ex 1999 and 2003).

```{r}
all_data_adj |> 
  pivot_longer(cols = c(ps,adj_ps), 
               names_to = "metric", values_to = "value") |> 
  filter((year %in% 1996:2000 & metric == "ps") | (year %in% 2016:2020 & metric == "adj_ps")) |> 
  ggplot(aes(x = value, fill = metric)) + 
  geom_histogram(position = "dodge")
```

These are a bit hard to compare because the tail gets so small so fast, but the values close to 0 look similar enough. We can zoom in on the tail, note that there isn't much to look at after 100:

```{r}
all_data_adj |> 
  pivot_longer(cols = c(ps,adj_ps), 
               names_to = "metric", values_to = "value") |> 
  filter((year %in% 1996:2000 & metric == "ps") | (year %in% 2016:2020 & metric == "adj_ps")) |> 
  ggplot(aes(x = value, fill = metric)) + 
  geom_histogram(position = "dodge") + 
  coord_cartesian(xlim = c(8.5, 100))
```

There seem to be a similar number of observations in each bin, so it seems like our estimations are reasonable. Note again that we are clear restrictions and potential sources of error with this approach, and in the model step we will fit a model using both the raw PS values and the adjusted PS values. Before moving on to the model step, we create a plot of the average PS and adjusted PS values, which is the same as the last plot in the visualize step except we will be including the adjusted PS values.

```{r, warning=FALSE}
all_data_adj |> 
  pivot_longer(cols = c(ps, adj_ps), names_to = "metric", values_to = "value") |> 
  group_by(metric, overall) |> 
  summarize(mean_val = mean(value)) |> 
  ggplot(aes(x = overall, y = mean_val, col = metric)) + 
  geom_point(alpha = 0.4)
```

The adjusted PS values are generally larger than the unadjusted PS values, which is what we would expect because $ps^{adj}_{ij} \ge ps_{ij}$, given than we add PS to players who are still active NHL players. We now proceed to the Model step where we will fit several models to this data.
