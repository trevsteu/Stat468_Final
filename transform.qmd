---
title: "Transform"
author: "Trevor S"
---

## Setup

We install and load the necessary packages, along with functions from prior chapters.

```{r,  message = FALSE, warning = FALSE}
# install.packages("tidyverse")
# install.packages("dplyr")
# install.packages("gt")

library(tidyverse)
library(dplyr)
library(gt)

source("functions.R") # load functions defined in prior chapters
```

## Introduction

In the transform step, we will transform our data to better include the careers of players who are still playing. In the previous chapter, we estimated the value of pick $n$ by taking the average PS of all players in out dataset drafted at pick $n$. As mentioned in the constraints section, one problem with this approach is that players drafted more recently will have had fewer years to generate PS. We can see in the plot below that, unsurprisingly, the total PS is quite a bit lower for the drafts between 2016 and 2020:

```{r}
all_data |> 
  group_by(year) |> 
  summarize(total_ps = sum(ps)) |>
  ggplot(aes(x = year, y = total_ps)) +
  geom_point()
```

A similar issue is that there are quite a few current players who can still generate additional PS in our dataset. This issue is related because it is probably reasonable to expect that the discrepency between the 2016-2020 PS totals and the other years is due to there being so many active players from those seasons.

```{r}
all_data |> 
  filter(to == 2025) |> 
  group_by(year) |> 
  summarize(current_players = n()) |>
  ggplot(aes(x = year, y = current_players)) + 
  geom_point()
```

We can see that there are still quite a few players who are currently playing, so the full value of their career cannot be fully known. It is interesting that PS is so high for the drafts between 2007 and 2015 even though there are still so many active players from those drafts, I did some research but I could not find anything about it. One of my theories is that elite players might be skewing things, but Connor McDavid was drafted in 2015 but even he "only" has about 125 PS which is not nearly enough to skew the data on its own. I guess it is possible there were just really strong drafts, but it seems odd that there would be 8 strong drafts in a row.

Estimating the remaining value of a player's career could be an entire project all on its own, so we have 3 options:

-   Only include drafts from before 2003 (there are no active NHL players who were drafted in 2002 or earlier).

-   Ignore this issue altogether (as if every active player in our dataset retired right now).

-   Make some sort of adjustment to the PS values of active players to account for the remainder of their career.

Neither of the first two options are particularly appealing. The first is unideal because of sample size concerns and the changes that have taken place in terms of draft eligibility and strategy since the 1980s (which we would need to include to maintain a sample size of 25). Additionally, the second option is arguably worse because it will severely underestimate the quality of star players drafted in the last few years (elite players can play for 15-20 seasons, so we could be missing three quarters of a player's career if he was drafted in 2020). Thus the only remaining option is to attempt to estimate the remaining value of a players career.

Estimating the remaining value of a player's career could be an entire project all on its own, but we will make an adjustment that will reduce the impact of this issue (while acknowledging that we will not completely fix it). Let $gp_{ps}$ and $ps_{ij}$ be the GP and PS of the player drafted at pick $i$ of draft $j$. If that player has not retired, we will set $ps^{mod}_{ij} = ps_{ij} + \frac{ps_{ij}}{gp_{ij}} \times \hat{yr_j}$, where $\hat {yr_j}$ is our [**estimate**]{.underline} of the number of years left in the career of players drafted in year $j$. We will estimate $yr_j$ later using data from 1996-2004. When we actually code this adjustment later in this chapter we will verify that the PS values these drafts end up looking similar to drafts where everyone is retired. Note that we only make this adjustment for active players, there is no reason to adjust the PS of retired players.

## Code

Let $yr_j$ be the nunber of years players drafted in draft $j$ have remaining in their career, given they were drafted $k$ years ago. We aim to estimate this value, and will do so by setting $\hat{yr_j}$ to be the median career length of players who retired at $k$ years after being drafted and were drafted between 1996 and 2004. We calculate it for $1 \le k \le 22$ to make the indexing more intuitive, even though we will only be using the values $k \ge 5$, since no active player drafted in 2020 or earlier can have played for less than 4 seasons..

```{r}
get_length <- function(len){ 
  all_data |> 
    mutate(rem_career_len = to - year - len) |> 
    filter(year %in% 1996:2004 & rem_career_len >= 0) |> 
    summarize(med = median(rem_career_len)) |> 
    pull(med)
}

est_yr <- data.frame(k = seq(1,22)) |> 
  rowwise() |> 
  mutate(yr = get_length(k)) |> 
  ungroup()

ggplot(est_yr, aes(x = k, y = yr)) + 
  geom_line() 
```

The interpretation for this is a player who was drafted 1 year ago has an estimated 9 years left in their career, a player who was drafted 5 years ago has an estimated 6 years left in their career, and a player who was drafted 10 years ago has an estimated 4 years remaining in their career. We can now make our adjustments:

```{r}
all_data_mod <- all_data |> 
  filter(to == 2025) |> 
  mutate(career_len = to - year) |> 
  rowwise() |> 
  mutate(mod_ps = ps + ps / gp * 82 * get_length(career_len)) |> 
  ungroup() |> 
  select(year:ps, mod_ps)

inactive_players <- all_data |> 
  filter(to != 2025) |> 
  mutate(mod_ps = ps)


all_data_mod <- rbind(all_data_mod, inactive_players)
all_data_mod
```

Note that the modified PS values for players who are expected to retire soon may not have changed at all. To say it again, this estimation is not perfect, but it is better than the alternatives (using older data or ignoring the issue). In particular, this method assumes all players will continue to generate PS at the same rate as they have to this point in their career, and that every player will play in a set number of additional years which only depend on how many years ago they were drafted.
