---
title: "Import"
author: "Trevor S"
---

## Setup

We install and load the necessary packages.

```{r, warnings = FALSE, message = FALSE}
# install.packages("rvest")
# install.packages("stringr")
# install.packages("tidyverse")
# install.packages("janitor")
# install.packages("gt")
library(rvest)
library(stringr)
library(tidyverse)
library(janitor)
library(gt)
```

## Introduction

In the import step we import the data required for this report. As mentioned before, we will be importing data from [Hockey Reference](https://www.hockey-reference.com/draft). Before we import any data, it's important to consider *which* and *how many* years we want to include in this analysis. Since the NHL has changed dramatically over the years, care must be taken to ensure we do not include drafts from too long ago. The primary concern with including data from too many years ago is that teams have likely changed their drafting approach over time. For example, teams may have become better at evaluating prospects as more advanced statistics have been developed, meaning that there are likely fewer late round draft "steals" in the 2020s than there were in the 1980s. Thus including drafts from the 1980s would skew our calculations because it would overestimate contributions by players who were drafted in the later rounds, since those players would potentially have been drafted sooner if the teams of the 1980s had the resources available to teams today. This would make our model a poor estimator of draft pick value for drafts occurring in the 2020s. That being said, players drafted in recent years have not had sufficient time to contribute to their teams, so we should not include drafts from too recently either. Ideally, we would wait until all players from a draft class have retired before including it in our analysis. Practically speaking, this is not feasible since players can have very long careers (for example, Alex Ovechkin was drafted in 2004 and is still playing) which would force us to include older drafts to maintain the same sample size, which is also not ideal as explained above.

Another consideration is that the formula for calculating a skater's PS (point share; the metric we will use for predicting pick value) changed in either the 1997-1998 or 1998-1999 season. There is conflicting info on what year it changed; [this link](https://www.hockey-reference.com/about/point_shares.html) says it changed in 1998-1999 because time on ice data was not available until 1998-1999, however [the page of 1997-1998 data](https://www.hockey-reference.com/leagues/NHL_1998_skaters.html) has time on ice data. In the seasons where time on ice data was not available, games played was used instead. To maintain consistency, we would prefer to minimize the number of players in our dataset who played before the 1998-1999 season, since those seasons were definitely under the old PS formula. The PS formula for goalies has been the same since the 1983-1984 season, so it is not an issue.

Taking these factors into consideration, we make the somewhat arbitrary decision to use the 25 drafts between and 1996 and 2020 (inclusive). We don't have the code to check this yet, but the table at the end of this chapter shows the number of skaters and total number of games played by players in our dataset under the old PS formula. We can see that it is minimal and thus unlikely to impact our conclusion. Also, we will see in the Visualize chapter that a significant portion of the players in our dataset are still active, so we may want to adjust for this, as will be discussed in the Transform chapter.

## Code

We start off by creating a function to import data from Hockey Reference.

```{r, message=FALSE, warnings = FALSE, warning = FALSE}
start_year <- 1996
end_year <- 2020

import_draft <- function(year){
  url <- str_glue("https://www.hockey-reference.com/draft/NHL_{year}_entry.html")
  html <- read_html(url)
  Sys.sleep(5) # to avoid getting rate limited
  draft_year_table <- html |> 
    html_element("table") |> 
    html_table() |> 
    janitor::row_to_names(1) |> 
    janitor::clean_names()
  draft_year_table
}

gt(head(import_draft(start_year), 10))
```

We compare the first 10 rows of the 1996 draft table shown above with the table on [Hockey Reference](https://www.hockey-reference.com/draft/NHL_1996_entry.html), and it seems that the function we created does what we want it to do. We can now find the number of skaters who played under the old PS formula. As mentioned earlier, it is not clear whether the PS formula changed in the 1997-1998 or 1998-1999 season, so we will check both. Note that players drafted in 1998 or later cannot have played in NHL games in the 1996-1997 or 1997-1998 seasons, so we only need to check players drafted in 1996 and 1997.

```{r, warning = FALSE}
draft_1996_1997 <- rbind(import_draft(1996), import_draft(1997)) |> 
  filter(pos != "G") |> # the ps formula for goalies is the same for our entire dataset
  select("player") # we just want to compare names

player_stats <- function(year){
  url <- str_glue("https://www.hockey-reference.com/leagues/NHL_{year}_skaters.html")
  html <- read_html(url)
  Sys.sleep(5) # to avoid getting rate limited
  stats_table <- html |> 
    html_element("table") |> 
    html_table() |> 
    janitor::row_to_names(1) |> 
    janitor::clean_names() |> 
    select(player, gp) |> 
    group_by(player) |> 
    # players who played for n > 1 teams get listed n+1 times; this fixes it 
    summarize(gp = max(gp), .groups = "drop")  
  stats_table 
}

player_stats_1996_1997 <- full_join(player_stats(1996), 
                                    player_stats(1997), 
                                    by = join_by(player))

old_ps_players <- player_stats_1996_1997 |> 
  rename(gp_1996 = gp.x, gp_1997 = gp.y) |> 
  filter(player %in% draft_1996_1997$player)

old_ps_players
```

We can see a very small proportion of the players in our dataset (approximately 5400 players) played games under the old PS formula, so the different PS formulas is not a major concern and is unlikely to meaningfully impact our results. We can now proceed to the Tidy step.
